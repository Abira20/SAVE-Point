"use strict";Backbone.ROComputedModel=Backbone.Model.extend({get:function(e){return void 0!==this.attributes[e]?this.attributes[e]:_.isFunction(this[e])?this[e]():this[e]}});var Mission=Backbone.ROComputedModel.extend({defaults:{completed:!1,elapsed:-1,elementsf:null,stars:0,lastPlayed:null,name:"",trialDurations:[],trialStars:[],trialActions:[],trialDates:[],trialData:[]},toJSON:function(){return _.pick(this.attributes,_.keys(this.defaults))}}),MissionCollection=Backbone.Collection.extend({model:Mission}),TYPE_STAR=0,TYPE_PLANET=1,TYPE_STAR_FIXED=2,TYPE_PLANET_FIXED=3,TYPE_HALO=4,App=Backbone.ROComputedModel.extend({defaults:function(){return{currentMission:0,state:PAUSED,showOrbit:!1,userStartTime:new Date,userEndTime:null,nplanets:0,time:0,deltat:1.5,dt:1.5,bodyTypes:[TYPE_STAR],position:[0,0,0],velocity:[0,0,0],masses:[1],defaultMass:0,missions:null,interactive:!0,invalid:!1,collided:!1,physicalSizes:!1,selectedPlanet:0,starsEarned:[],maxAU:1.5,minAU:.19,musicVolume:.2,effectsVolume:.2}},saveKeys:["musicVolume","effectsVolume"],components:{},flags:{},resetFlags:function(){this.flags={}},toggleState:function(){var e=this.get("state");e==RUNNING?this.set("state",PAUSED):e==PAUSED?this.set("state",RUNNING):console.warn("app.toggleState() was used when state is ",e)},sync:function(){throw new Error("TODO: Sync method for App model.")},addPlanet:function(e,t){if(!this.ensureConstraints())return-1;var s=this.get("position"),i=this.get("velocity"),n=this.get("masses"),a=this.get("bodyTypes");s.push(e[0],e[1],0),t&&t.type?a.push(t.type):a.push(TYPE_PLANET);var o=Math.sqrt(K2);if(t&&t.circular){var r=Math.sqrt(e[0]*e[0]+e[1]*e[1]);o=Math.sqrt(K2/r),i.push(o*(-e[1]/r),o*(e[0]/r),0)}else i.push(o,0,0);return n.push(this.get("defaultMass")),this.ctx.elements=null,this.set("nplanets",this.get("nplanets")+1),this.ensureConstraintsForBody(this.get("nplanets")-1),this.ctx.elements=null,this.trigger("addPlanet change:position change:velocity change:masses"),this.set("selectedPlanet",this.get("nplanets")),Physics.barycenter(this.ctx),n.length},setPositionForBody:function(e,t){var s=this.get("position");s[(e+1)*NPHYS+X]=t[0],s[(e+1)*NPHYS+Y]=t[1],s[(e+1)*NPHYS+Z]=t[2],this.ensureConstraintsForBody(e)&&this.trigger("change:velocity"),this.trigger("change:position"),Physics.barycenter(this.ctx)},positionForBody:function(e,t){t=t||[];var s=this.get("position");return t[0]=s[(e+1)*NPHYS+X],t[1]=s[(e+1)*NPHYS+Y],t[2]=s[(e+1)*NPHYS+Z],t},typeForBody:function(e){return this.get("bodyTypes")[e+1]},forceForBody:function(e,t){t=t||3;var s=[0,0,0],i=this.get("position"),n=this.get("masses"),a=app.get("nplanets")+1;e+=1;for(var o=i[e*NPHYS+X],r=i[e*NPHYS+Y],l=i[e*NPHYS+Z],p=0;a>p;p++)if(p!=e){var h=i[p*NPHYS+X],c=i[p*NPHYS+Y],d=i[p*NPHYS+Z],u=n[p],m=Math.sqrt((h-o)*(h-o)+(c-r)*(c-r)+(d-l)*(d-l)),g=Math.pow(m,t);s[X]+=-K2*u*(o-h)/g,s[Y]+=-K2*u*(r-c)/g,s[Z]+=-K2*u*(l-d)/g}return s},ensureConstraints:function(){var e=app.mission().get("constraints");if(!e)return!0;if(!e.nplanets)return!0;var t=this.get("nplanets"),s=!0;return s&=t<e.nplanets},ensureConstraintsForBody:function(e){var t=app.mission().get("constraints");if(!t)return!1;var s=!1,i=this.get("position"),n=[i[(e+1)*NPHYS+X],i[(e+1)*NPHYS+Y],i[(e+1)*NPHYS+Z]],a=this.get("velocity"),o=[a[(e+1)*NPHYS+X],a[(e+1)*NPHYS+Y],a[(e+1)*NPHYS+Z]];if("perpendicular"==t.direction){var r=_m.norm(o),l=_m.norm(n);o[0]=-n[1]/l*r,o[1]=n[0]/l*r,o[2]=o[2],a[(e+1)*NPHYS+X]=o[0],a[(e+1)*NPHYS+Y]=o[1],a[(e+1)*NPHYS+Z]=o[2],s=!0}if(t.speed){var p=t.speed/(Units.RUNIT/Units.TUNIT/1e5);r=_m.norm(o),a[(e+1)*NPHYS+X]=o[0]/r*p,a[(e+1)*NPHYS+Y]=o[1]/r*p,a[(e+1)*NPHYS+Z]=o[2]/r*p}return s},setVelocityForBody:function(e,t){var s=this.get("velocity");s[(e+1)*NPHYS+X]=t[0],s[(e+1)*NPHYS+Y]=t[1],s[(e+1)*NPHYS+Z]=t[2],this.ensureConstraintsForBody(e),Physics.barycenter(this.ctx),this.trigger("change:velocity")},barycenter:function(){return this.ctx.bary},tick:function(){if(!this.get("invalid")&&this.get("state")!=MENU){{var e=this.get("time"),t=this.get("deltat");this.get("nplanets")}this.ctx.t=e,this.ctx.x=this.get("position"),this.ctx.v=this.get("velocity"),this.ctx.M=this.get("masses");for(var s=t*SPEED,i=1;i<=app.get("nplanets");i++){var n=Math.sqrt(this.ctx.x[i*NPHYS+X]*this.ctx.x[i*NPHYS+X]+this.ctx.x[i*NPHYS+Y]*this.ctx.x[i*NPHYS+Y]);s=Math.min(s,.05*Math.sqrt(n*n*n/K2))}for(var a=!1,o=this.get("minAU"),r=t/s|0,l=t%s,p=0;r>=p&&!(p==r&&1e-8>l);p++){for(p==r&&(s=l),Physics.leapfrog(this.ctx.t+s,this.ctx),i=1;i<=app.get("nplanets");i++){var h=this.ctx.x[i*NPHYS+X]-this.ctx.x[X],c=this.ctx.x[i*NPHYS+Y]-this.ctx.x[Y],d=this.ctx.x[i*NPHYS+Z]-this.ctx.x[Z];n=Math.sqrt(h*h+c*c+d*d),o>n&&(a={x:this.ctx.x[i*NPHYS+X],y:this.ctx.x[i*NPHYS+Y],planet:i})}if(a)break}this.set("time",e+t),this.trigger("change:position"),this.trigger("change:velocity"),a&&(this.trigger("collision",a),this.set("collided",!0),this.set("invalid",!0)),Physics.barycenter(this.ctx),this.trigger("tick")}},elements:function(e){if(this.ctx.elements&&!e)return this.ctx.elements;var t=this.get("position"),s=this.get("velocity"),i=this.get("masses"),n=this.get("nplanets");this.ctx.Mstar=i[0],this.ctx.twoD=!0,this.ctx.elements&&this.ctx.elements.length==n||(this.ctx.elements=[]);for(var a=1;n>=a;a++){var o=t[a*NPHYS+X]-t[X],r=t[a*NPHYS+Y]-t[Y],l=t[a*NPHYS+Z]-t[Z],p=s[a*NPHYS+X]-s[X],h=s[a*NPHYS+Y]-s[Y],c=s[a*NPHYS+Z]-s[Z];this.ctx.elements[a-1]=Physics.x2el(this.ctx,0,i[a],o,r,l,p,h,c,this.ctx.elements[a-1])}return this.trigger("change:elements"),this.ctx.elements},win:function(){this.set("userEndTime",new Date);var e=this.get("missions").at(this.get("currentMission"));e.set("completed",!0),e.set("elapsed",this.elapsedTime(!0)),e.set("stars",Math.max(e.get("stars"),this.stars())),e.set("elements",this.elements()),e.set("lastPlayed",new Date),this.trigger("win"+this.stars()),this.trigger("win"),app.saveMissionData()},lose:function(){this.set("userEndTime",new Date),this.trigger("lose"),app.saveMissionData()},setMission:function(mission){void 0===mission&&(mission=this.get("currentMission")+1);var self=this;_.isString(mission)&&app.get("missions").find(function(e,t){return e.get("name")===mission?(mission=t,!0):!1}),this.set({currentMission:mission}),this.reset();var missionObj=this.mission();this.sounds.playMusic(missionObj.get("music"));var bodies=missionObj.get("bodies");bodies&&_.each(bodies,function(body){var type=TYPE_PLANET;body.type&&(type=eval(body.type));var i=self.addPlanet(body.x,{type:type,circular:body.circular});body.v&&self.setVelocityForBody(i-1,body.v)})},menu:function(){app.saveMissionData(),this.set("state",MENU)},elapsedTime:function(e){var t=this.get("userEndTime")||new Date,s=Math.round((t.getTime()-this.get("userStartTime").getTime())/1e3);if(e)return s;var i=Math.floor(s/60);return s%=60,i+":"+(10>s?"0"+s:s)},stars:function(){var e=app.mission(),t=e.get("starsrule");return _.isFunction(t)?t():e.get("value")||3},starsEarnedTotal:function(){return app.get("missions").reduce(function(e,t){return e+t.get("stars")},0)},reset:function(){var e=this.defaults();this.set({masses:e.masses,position:e.position,velocity:e.velocity,types:e.types,nplanets:e.nplanets,time:e.time,state:e.state,currentHelp:e.currentHelp,userStartTime:new Date,userEndTime:null,invalid:e.invalid,collided:e.collided,selectedPlanet:e.selectedPlanet}),this.ctx.elements=null,this.trigger("reset"),this.trigger("start"),app.component&&app.component.stopListening();var t=app.mission();t.get("type")&&app.components[t.get("type")]&&(app.component=new(app.components[t.get("type")])({model:this}))},loadConfig:function(e){var t=e.missions,s=new MissionCollection,i=0;_.each(t,function(e){var t=new Mission(e);s.add(t),i+=t.get("value")||3}),delete e.missions,this.set(e),this.set("missions",s),this.set("starsBounty",i)},loadMissionData:function(){this.trigger("loading");var e=this;_.defer(function(){$.get("php/gamedata.php?action=load").done(function(t){if(""!=t.trim()){for(var s=JSON.parse(t),i=s.missions||[],n=s.saveData||{},a=e.get("missions"),o=0;o<i.length;o++)if(i[o].name){var r=a.where({name:i[o].name});!r||0==r.length||r.length>1?console.error("Mission named "+i[o].name+" has either 0 or multiple corresponding missions in the configuration file."):r[0].set(i[o])}else console.error("Mission #"+o+" does not have a name property.");_.each(n,function(t,s){e.set(t,s)})}_.delay(function(){app.trigger("load"),app.menu()},3e3)})})},saveMissionData:function(){var e=this,t={};_.each(this.saveKeys,function(t){this[t]=e.get(t)},t);var s={missions:app.get("missions"),saveData:t},i=JSON.stringify(s),n=app.starsEarnedTotal();return app.trigger("saving"),$.post("php/gamedata.php?action=save",{data:i,earned_stars:n}).done(function(e){app.trigger("saved",e)}),s},resetMissionData:function(){$.post("php/gamedata.php?action=reset").done(function(){location.reload()})},mission:function(e){if(e){if(_.isNumber(e))return app.get("missions").at(e);var t=app.get("missions").where({name:e});return t.length>1&&console.error("Warning, multiple missions with name ",name),t[0]}return app.get("missions").at(app.get("currentMission"))},animateUntil:function(e,t,s,i){i=i||0;var n=_.extend({},Backbone.Events),a=!1;n.listenTo(this,e,function(){a=!0,n.off(),_.defer(s)});var o=function(){a||(t(),requestAnimationFrame(o))};_.delay(o,i)},getHumanInfoForBody:function(e){e+=1;var t=this.get("position"),s=this.get("velocity"),i=Math.sqrt((t[X]-t[e*NPHYS+X])*(t[X]-t[e*NPHYS+X])+(t[Y]-t[e*NPHYS+Y])*(t[Y]-t[e*NPHYS+Y])+(t[Z]-t[e*NPHYS+Z])*(t[Z]-t[e*NPHYS+Z])),n=Math.sqrt((s[X]-s[e*NPHYS+X])*(s[X]-s[e*NPHYS+X])+(s[Y]-s[e*NPHYS+Y])*(s[Y]-s[e*NPHYS+Y])+(s[Z]-s[e*NPHYS+Z])*(s[Z]-s[e*NPHYS+Z]));return{distance:(i*Units.RUNIT/1e11).toFixed(1)+" million km",speed:(n*Units.RUNIT/Units.TUNIT/1e5).toFixed(1)+" km/s"}},initialize:function(){var e=this;this.ctx={M:this.get("masses"),x:this.get("position"),v:this.get("velocity"),dt:.25},this.listenTo(this,"planet:drag planet:dragvelocity",function(){this.elements(!0)}),this.listenTo(this,"change:state",function(){e.get("state")==PAUSED?app.trigger("state:paused"):e.get("state")==RUNNING?app.trigger("state:running"):e.get("state")==ROTATABLE?app.trigger("state:rotatable"):e.get("state")==MENU&&app.trigger("state:menu")})}}),app=new App,AppView=Backbone.View.extend({el:$("#app"),events:{"click #menu":function(){$("#sidebar").toggleClass("expanded")},"click #help":function(){this.renderMission(),app.trigger("hint")},"click #practice":function(){app.setMission("sandbox")},"click #reset":function(){app.reset()},"click #missions":function(){app.menu()},"click #dashboard":function(){location.href="../dashboard/"},"click #sizes":function(){app.set("physicalSizes",!app.get("physicalSizes"))},"click #zoom-in":function(){draw.setZoom(2*draw.zoom)},"click #zoom-out":function(){draw.setZoom(draw.zoom/2)},"click #zoom":function(){$("#toolbar-zoom").addClass("expanded").removeClass("hidden")},"click #zoom-close":function(){$("#toolbar-zoom").removeClass("expanded").addClass("hidden")}},initialize:function(){var e=this;e.listenTo(e.model,"change:nplanets change:time change:position change:velocity change:elements change:selectedPlanet",_.throttle(e.renderInfo,200)),e.listenTo(e.model,"start change:missions reset",e.renderMission),e.listenTo(e.model,"change:state",e.setVisibility),e.listenTo(e.model,"win",e.renderWin),e.listenTo(e.model,"lose",e.renderLose),this.renderInfo(),e.listenTo(e.model,"start change:missions reset",function(){e.validateTimer&&clearTimeout(e.validateTimer)}),e.listenTo(e.model,"change:state",function(){app.get("state")==RUNNING&&(e.validateTimer&&clearTimeout(e.validateTimer),e.validateTimer=_.delay(_.bind(e.validate,e),5e3))})},missionTemplate:_.template('<div class="title"><%= title %></div><div class="subtitle"><%= subtitle %></div>'),missionDelay:7e3,topHideTimer:null,renderTopText:function(e,t){$("#text-top").html(e),$("#text-top").addClass("expanded"),$("#text-top").removeClass("in-front"),this.topHideTimer&&clearTimeout(this.topHideTimer),t&&(this.topHideTimer=_.delay(function(){$("#text-top").removeClass("expanded"),$("#text-top").removeClass("in-front")},this.missionDelay))},renderMission:function(){if(app.get("state")==PAUSED){var e=this.model.get("currentMission"),t=this.model.get("missions").at(e);this.renderTopText(this.missionTemplate(t.attributes),!0)}},els:{},renderInfo:function(){if(app.get("nplanets")>0){$("#time").text(this.model.get("time")+" days");var e=app.get("selectedPlanet")-1,t=app.getHumanInfoForBody(e);$("#distance").html(t.distance),$("#speed").text(t.speed),$(".val-planet").css("color",draw.color(TYPE_HALO,e))}else $("#distance").text(""),$("#speed").text(""),$("#eccentricity").text(""),$("#time").text("")},setVisibility:function(){var e=app.get("state");e==MENU?($("#sidebar").hide(),$("#help-text").removeClass("expanded"),$("#info-top").hide(),$("#help").hide(),$("#text-top").removeClass("expanded")):($("#sidebar").show(),$("#info-top").show(),$("#help").show())},canvasMouseDown:function(e){app.get("state")==PAUSED&&app.addPlanet(e.position)},validate:function(){if(app.mission().get("rule")){var e=app.mission().get("rule")();e?(this.model.win(),clearInterval(this.validateTimer)):this.model.lose()}},winTemplate:_.template('<div class="font-l"><%= win %></div><div class="font-l"><div class="color-accent"><%= stars %></div><button class="btn-jrs font-m" onClick="app.menuView.selectNextMission(); app.menu();"><span class="fa fa-graduation-cap"></span> Go to the next mission!</button></div>'),defaultEncouragement:"Good job!",winDelayMax:1e4,approxFrameRate:1/60,renderWin:function(){var e=app.mission(),t=app.get("elements"),s=0;t.length>0&&!isNaN(t[0].period)&&(s=Math.min(this.winDelayMax,t[0].period/app.get("deltat")*this.approxFrameRate*1e3)),s=Math.max(4e3,s),this.renderTopText(this.winTemplate({win:e.get("win"),stars:app.templates.starsRepr(app.stars(),app.mission().get("value"))}),!1),$("#text-top").addClass("in-front"),app.set("state",ROTATABLE)},loseTemplate:_.template('<div class="subtitle"><%= lose %></div><div><button class="btn-jrs font-m" onClick="app.reset(); app.mainView.renderMission(); "><span class="icon-thumbs-up"></span> No worries! Retry mission</button></div>'),renderLose:function(){var e=app.get("missions").at(app.get("currentMission"));$("#text-top").html(this.loseTemplate(e.attributes)),$("#text-top").addClass("expanded"),$("#text-top").addClass("in-front"),app.set("state",ROTATABLE)},auxToolbar:function(){}}),MissionHelpModel=Backbone.Model.extend({defaults:{model:app,currentHelp:0},proceed:function(){this.trigger("help",null),this.set("currentHelp",this.get("currentHelp")+1),this.trigger("proceed"),app.trigger("proceed")},destroy:function(){this.stopListening()},setup:function(){var e=this.get("model"),t=e.mission();if(!t.get("help"))return this.trigger("help",null),void 0;this.listenTo(e,"win",function(){this.destroy()});for(var s=t.get("help"),i=this,n=[],a=0;a<s.length;a++){var o=s[a].on;o&&("proceed"==o?this.listenTo(this,o,function(e){return function(){i.get("currentHelp")==e&&i.trigger("help",s[e])}}(a)):this.listenTo(e,o,function(e,t){return function(){n[e]||(i.trigger("help",s[e]),i.set("currentHelp",e),"hint"!=t&&(n[e]=!0))}}(a,o)),"start"==o&&this.trigger("help",t.get("help")[0]))}},initialize:function(){}}),MessageView=Backbone.View.extend({el:$("#help-body"),messagesSetup:!1,initialize:function(){this.listenToOnce(this.model,"start",function(){this.setupTemplates()}),this.listenTo(this.model,"start",function(){this.render(null),this.setupMessages()}),this.listenTo(this.model,"win lose",function(){e.render(null)});var e=this;$("#help-next").on("click",function(){e.model.proceed()})},setupTemplates:function(){if(!this.messagesSetup){for(var e=this.model.get("missions"),t=0,s=0;s<e.length;s++){var i=e.at(s),n=i.get("help");if(n){for(var a=0;a<n.length;a++)app.templates.template(n[a]),n[a].id=t,t++;i.set("help",n)}}this.messagesSetup=!0}},setupMessages:function(){this.listener&&(this.stopListening(this.listener),this.listener.destroy(),this.listener=null),this.listener=new MissionHelpModel({model:this.model}),this.listenTo(this.listener,"help",this.render),this.listenTo(this.model,"help",this.render),this.listener.setup()},plainText:function(e){return e.replace(/<script.+?<\/script>/,"").replace(/<button.+?<\/button>/,"").replace(/<.+?>/g,"").replace(/&.+;/g,"")},shown:{},render:function(help){var helpText=help?help.message:null,self=this;return helpText&&self.lastHelp==helpText?($("#help-text").addClass("expanded"),void 0):(null!=help&&help.showOnce&&this.shown[help.id]&&(helpText=null),self.lastHelp=helpText,_.defer(function(){app.set("interactive",!0),app.resetFlags()}),_.defer(function(){if(help&&help.funcs)for(var e=0;e<help.funcs.length;e++)help.funcs[e]()}),$("#help-text").removeClass("expanded"),helpText?(help.script&&eval(help.script),_.delay(function(){self.$el.html(helpText),self.shown[help.id]=!0;self.plainText(helpText);if($("#help-next").on("click",function(){self.listener.proceed()}),$("#help-close").on("click",function(){self.hide()}),$("#help-next-mission").on("click",function(){self.model.nextMission()}),$("#help-text").addClass("expanded"),app.trigger("show:help"),app.mainView.renderInfo(),help&&help.funcs)for(var e=0;e<help.funcs.length;e++)help.funcs[e]()},200),void 0):($("#help-body").html(""),void 0))},hide:function(){this.render(null)}}),AppModalView=Backbone.View.extend({el:$("#app-modal"),animate:!1,size:10,initialize:function(){this.listenTo(this.model,"loading",this.renderLoading),this.listenTo(this.model,"load",this.renderLoad),this.frame=_.bind(this.frame,this)},loadingMessage:'Traveling to the <%= world %>...<p><i class="fa fa-circle-o-notch fa-spin"></i>',frame:function(){this.size=1.01*this.size,$("#app-modal").css("background-size",this.size+"%"),this.animate&&requestAnimationFrame(this.frame)},renderLoading:function(){var e=app.get("map");this.animate=!0,this.size=10,$("#app-modal").css("background-image","url("+e[0]["travel-bg"]+")"),$("#app-modal").css("background-size","10%"),console.log(e[0].world),$("#app-modal").html(_.template(this.loadingMessage)(e[0])),$("#app").hide(),this.$el.show(),requestAnimationFrame(this.frame)},renderLoad:function(){$("#app").show(),this.animate=!1,this.$el.hide()}});$(document).ready(function(){app.mainView=new AppView({model:app}),app.loadConfig(APP_CFG),app.templates=new Templates,app.messageView=new MessageView({model:app}),app.menuView=new AppMenuView({model:app}),app.modalView=new AppModalView({model:app}),app.settings=new AppSettings({model:app}),app.loadMissionData(),app.sounds=new SoundEngine(app),APP_CFG=null,app.once("load",function(){app.sounds.playMusic("level"),null!=_.parameter("mission")&&_.defer(function(){app.setMission(_.parameter("mission"))})})});
//# sourceMappingURL=app_source_map