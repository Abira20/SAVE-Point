"use strict";var Actions=_.extend({},Backbone.Events);Actions.listenTo(app,"start",function(){var e=app.mission();console.log(this),this.actions=e.get("trialActions"),this.durations=e.get("trialDurations"),this.stars=e.get("trialStars"),this.data=e.get("trialData"),e.get("trialData").push({userAgent:navigator.userAgent}),e.get("trialDates").push(new Date)}),Actions.listenTo(app,"win",function(){this.stars.push(app.stars()),this.durations.push(app.elapsedTime(!0))}),Actions.listenTo(app,"lose",function(){this.stars.push(0),this.durations.push(app.elapsedTime(!0))}),_.each(["change:position","change:velocity"],function(e){Actions.listenTo(app,e,function(){app.get("interactive")&&Actions.actions[Actions.actions.length-1].action!=e&&Actions.actions.push({action:e,time:new Date})})}),_.each(["addPlanet"],function(e){Actions.listenTo(app,e,function(){app.get("interactive")&&Actions.actions.push({action:e,time:new Date})})}),Backbone.ROComputedModel=Backbone.Model.extend({get:function(e){return void 0!==this.attributes[e]?this.attributes[e]:_.isFunction(this[e])?this[e]():this[e]}});var Mission=Backbone.ROComputedModel.extend({defaults:{completed:!1,elapsed:-1,elements:null,stars:0,lastPlayed:null,name:"",trialDurations:[],trialStars:[],trialActions:[],trialDates:[],trialData:[]},toJSON:function(){return _.pick(this.attributes,_.keys(this.defaults))}}),MissionCollection=Backbone.Collection.extend({model:Mission}),TYPE_STAR=0,TYPE_PLANET=1,TYPE_STAR_FIXED=2,TYPE_PLANET_FIXED=3,TYPE_HALO=4,App=Backbone.ROComputedModel.extend({defaults:function(){return{currentMission:0,state:PAUSED,showOrbit:!1,userStartTime:new Date,userEndTime:null,nplanets:0,time:0,deltat:1.5,dt:1.5,bodyTypes:[TYPE_STAR],position:[0,0,0],velocity:[0,0,0],masses:[1],defaultMass:0,missions:null,interactive:!0,invalid:!1,collided:!1,physicalSizes:!1,starsEarned:[],maxAU:1.5,minAU:.19,musicVolume:.2,effectsVolume:.2}},saveKeys:["musicVolume","effectsVolume"],components:{},flags:{},resetFlags:function(){this.flags={}},toggleState:function(){var e=this.get("state");e==RUNNING?this.set("state",PAUSED):e==PAUSED?this.set("state",RUNNING):console.warn("app.toggleState() was used when state is ",e)},sync:function(){throw new Error("TODO: Sync method for App model.")},addPlanet:function(e,t){if(!this.ensureConstraints())return-1;var s=this.get("position"),i=this.get("velocity"),n=this.get("masses"),a=this.get("bodyTypes");s.push(e[0],e[1],0),t&&t.type?a.push(t.type):a.push(TYPE_PLANET);var o=Math.sqrt(K2);if(t&&t.circular){var l=Math.sqrt(e[0]*e[0]+e[1]*e[1]);o=Math.sqrt(K2/l),i.push(o*(-e[1]/l),o*(e[0]/l),0)}else i.push(o,0,0);return n.push(this.get("defaultMass")),this.ctx.elements=null,this.set("nplanets",this.get("nplanets")+1),this.ensureConstraintsForBody(this.get("nplanets")-1),this.ctx.elements=null,this.trigger("addPlanet change:position change:velocity change:masses"),Physics.barycenter(this.ctx),n.length},setPositionForBody:function(e,t){var s=this.get("position");s[(e+1)*NPHYS+X]=t[0],s[(e+1)*NPHYS+Y]=t[1],s[(e+1)*NPHYS+Z]=t[2],this.ensureConstraintsForBody(e)&&this.trigger("change:velocity"),this.trigger("change:position"),Physics.barycenter(this.ctx)},positionForBody:function(e,t){t=t||[];var s=this.get("position");return t[0]=s[(e+1)*NPHYS+X],t[1]=s[(e+1)*NPHYS+Y],t[2]=s[(e+1)*NPHYS+Z],t},typeForBody:function(e){return this.get("bodyTypes")[e+1]},forceForBody:function(e,t){t=t||3;var s=[0,0,0],i=this.get("position"),n=this.get("masses"),a=app.get("nplanets")+1;e+=1;for(var o=i[e*NPHYS+X],l=i[e*NPHYS+Y],r=i[e*NPHYS+Z],p=0;a>p;p++)if(p!=e){var c=i[p*NPHYS+X],h=i[p*NPHYS+Y],d=i[p*NPHYS+Z],m=n[p],u=Math.sqrt((c-o)*(c-o)+(h-l)*(h-l)+(d-r)*(d-r)),g=Math.pow(u,t);s[X]+=-K2*m*(o-c)/g,s[Y]+=-K2*m*(l-h)/g,s[Z]+=-K2*m*(r-d)/g}return s},ensureConstraints:function(){var e=app.mission().get("constraints");if(!e)return!0;if(!e.nplanets)return!0;var t=this.get("nplanets"),s=!0;return s&=t<e.nplanets},ensureConstraintsForBody:function(e){var t=app.mission().get("constraints");if(!t)return!1;var s=!1,i=this.get("position"),n=[i[(e+1)*NPHYS+X],i[(e+1)*NPHYS+Y],i[(e+1)*NPHYS+Z]],a=this.get("velocity"),o=[a[(e+1)*NPHYS+X],a[(e+1)*NPHYS+Y],a[(e+1)*NPHYS+Z]];if("perpendicular"==t.direction){var l=_m.norm(o),r=_m.norm(n);o[0]=-n[1]/r*l,o[1]=n[0]/r*l,o[2]=o[2],a[(e+1)*NPHYS+X]=o[0],a[(e+1)*NPHYS+Y]=o[1],a[(e+1)*NPHYS+Z]=o[2],s=!0}if(t.speed){var p=t.speed/(Units.RUNIT/Units.TUNIT/1e5);l=_m.norm(o),a[(e+1)*NPHYS+X]=o[0]/l*p,a[(e+1)*NPHYS+Y]=o[1]/l*p,a[(e+1)*NPHYS+Z]=o[2]/l*p}return s},setVelocityForBody:function(e,t){var s=this.get("velocity");s[(e+1)*NPHYS+X]=t[0],s[(e+1)*NPHYS+Y]=t[1],s[(e+1)*NPHYS+Z]=t[2],this.ensureConstraintsForBody(e),Physics.barycenter(this.ctx),this.trigger("change:velocity")},barycenter:function(){return this.ctx.bary},tick:function(){if(!this.get("invalid")&&this.get("state")!=MENU){{var e=this.get("time"),t=this.get("deltat");this.get("nplanets")}this.ctx.t=e,this.ctx.x=this.get("position"),this.ctx.v=this.get("velocity"),this.ctx.M=this.get("masses");for(var s=t,i=1;i<=app.get("nplanets");i++){var n=Math.sqrt(this.ctx.x[i*NPHYS+X]*this.ctx.x[i*NPHYS+X]+this.ctx.x[i*NPHYS+Y]*this.ctx.x[i*NPHYS+Y]);s=Math.min(s,.05*Math.sqrt(n*n*n/K2))}for(var a=!1,o=this.get("minAU"),l=t/s|0,r=t%s,p=0;l>=p&&!(p==l&&1e-8>r);p++){for(p==l&&(s=r),Physics.leapfrog(this.ctx.t+s,this.ctx),i=1;i<=app.get("nplanets");i++){var c=this.ctx.x[i*NPHYS+X]-this.ctx.x[X],h=this.ctx.x[i*NPHYS+Y]-this.ctx.x[Y],d=this.ctx.x[i*NPHYS+Z]-this.ctx.x[Z];n=Math.sqrt(c*c+h*h+d*d),o>n&&(a={x:this.ctx.x[i*NPHYS+X],y:this.ctx.x[i*NPHYS+Y],planet:i})}if(a)break}this.set("time",e+t),this.trigger("change:position"),this.trigger("change:velocity"),a&&(this.trigger("collision",a),this.set("collided",!0),this.set("invalid",!0)),Physics.barycenter(this.ctx),this.trigger("tick")}},elements:function(e){if(this.ctx.elements&&!e)return this.ctx.elements;var t=this.get("position"),s=this.get("velocity"),i=this.get("masses"),n=this.get("nplanets");this.ctx.Mstar=i[0],this.ctx.twoD=!0,this.ctx.elements&&this.ctx.elements.length==n||(this.ctx.elements=[]);for(var a=1;n>=a;a++){var o=t[a*NPHYS+X]-t[X],l=t[a*NPHYS+Y]-t[Y],r=t[a*NPHYS+Z]-t[Z],p=s[a*NPHYS+X]-s[X],c=s[a*NPHYS+Y]-s[Y],h=s[a*NPHYS+Z]-s[Z];this.ctx.elements[a-1]=Physics.x2el(this.ctx,0,i[a],o,l,r,p,c,h,this.ctx.elements[a-1])}return this.trigger("change:elements"),this.ctx.elements},win:function(){this.set("userEndTime",new Date);var e=this.get("missions").at(this.get("currentMission"));e.set("completed",!0),e.set("elapsed",this.elapsedTime(!0)),e.set("stars",Math.max(e.get("stars"),this.stars())),e.set("elements",this.elements()),e.set("lastPlayed",new Date),this.trigger("win"+this.stars()),this.trigger("win"),app.saveMissionData()},lose:function(){this.set("userEndTime",new Date),this.trigger("lose"),app.saveMissionData()},setMission:function(mission){void 0===mission&&(mission=this.get("currentMission")+1);var self=this;_.isString(mission)&&app.get("missions").find(function(e,t){return e.get("name")===mission?(mission=t,!0):!1}),this.set({currentMission:mission}),this.reset();var missionObj=this.mission();this.sounds.playMusic(missionObj.get("music"));var bodies=missionObj.get("bodies");bodies&&_.each(bodies,function(body){var type=TYPE_PLANET;body.type&&(type=eval(body.type));var i=self.addPlanet(body.x,{type:type,circular:body.circular});body.v&&self.setVelocityForBody(i-1,body.v)})},menu:function(){app.saveMissionData(),this.set("state",MENU)},elapsedTime:function(e){var t=this.get("userEndTime")||new Date,s=Math.round((t.getTime()-this.get("userStartTime").getTime())/1e3);if(e)return s;var i=Math.floor(s/60);return s%=60,i+":"+(10>s?"0"+s:s)},stars:function(){var e=app.mission(),t=e.get("starsrule");return _.isFunction(t)?t():e.get("value")},starsEarnedTotal:function(){return app.get("missions").reduce(function(e,t){return e+t.get("stars")},0)},reset:function(){var e=this.defaults();this.set({masses:e.masses,position:e.position,velocity:e.velocity,types:e.types,nplanets:e.nplanets,time:e.time,state:e.state,currentHelp:e.currentHelp,userStartTime:new Date,userEndTime:null,invalid:e.invalid,collided:e.collided}),this.ctx.elements=null,this.trigger("reset"),this.trigger("start"),app.component&&app.component.stopListening();var t=app.mission();t.get("type")&&app.components[t.get("type")]&&(app.component=new(app.components[t.get("type")])({model:this}))},loadConfig:function(e){var t=e.missions,s=new MissionCollection,i=0;_.each(t,function(e){var t=new Mission(e);s.add(t),i+=t.get("value")||3}),delete e.missions,this.set(e),this.set("missions",s),this.set("starsBounty",i)},loadMissionData:function(){this.trigger("loading");var e=this;_.defer(function(){$.get("php/gamedata.php?action=load").done(function(t){if(""!=t.trim()){for(var s=JSON.parse(t),i=s.missions||[],n=s.saveData||{},a=e.get("missions"),o=0;o<i.length;o++)if(i[o].name){var l=a.where({name:i[o].name});!l||0==l.length||l.length>1?console.error("Mission named "+i[o].name+" has either 0 or multiple corresponding missions in the configuration file."):l[0].set(i[o])}else console.error("Mission #"+o+" does not have a name property.");_.each(n,function(t,s){e.set(t,s)})}_.delay(function(){app.trigger("load"),app.menu()},3e3)})})},saveMissionData:function(){var e=this,t={};_.each(this.saveKeys,function(t){this[t]=e.get(t)},t);var s=JSON.stringify({missions:app.get("missions"),saveData:app.get("saveData")}),i=app.starsEarnedTotal();app.trigger("saving"),$.post("php/gamedata.php?action=save",{data:s,earned_stars:i}).done(function(e){app.trigger("saved",e)})},resetMissionData:function(){$.post("php/gamedata.php?action=reset").done(function(){location.reload()})},mission:function(e){if(e){if(_.isNumber(e))return app.get("missions").at(e);var t=app.get("missions").where({name:e});return t.length>1&&console.error("Warning, multiple missions with name ",name),t[0]}return app.get("missions").at(app.get("currentMission"))},animateUntil:function(e,t,s,i){i=i||0;var n=_.extend({},Backbone.Events),a=!1;n.listenTo(this,e,function(){a=!0,n.off(),_.defer(s)});var o=function(){a||(t(),requestAnimationFrame(o))};_.delay(o,i)},getHumanInfoForBody:function(e){e+=1;var t=this.get("position"),s=this.get("velocity"),i=Math.sqrt((t[X]-t[e*NPHYS+X])*(t[X]-t[e*NPHYS+X])+(t[Y]-t[e*NPHYS+Y])*(t[Y]-t[e*NPHYS+Y])+(t[Z]-t[e*NPHYS+Z])*(t[Z]-t[e*NPHYS+Z])),n=Math.sqrt((s[X]-s[e*NPHYS+X])*(s[X]-s[e*NPHYS+X])+(s[Y]-s[e*NPHYS+Y])*(s[Y]-s[e*NPHYS+Y])+(s[Z]-s[e*NPHYS+Z])*(s[Z]-s[e*NPHYS+Z]));return{distance:(i*Units.RUNIT/1e11).toFixed(1)+" million km",speed:(n*Units.RUNIT/Units.TUNIT/1e5).toFixed(1)+" km/s"}},initialize:function(){this.ctx={M:this.get("masses"),x:this.get("position"),v:this.get("velocity"),dt:.25},this.listenTo(this,"planet:drag planet:dragvelocity",function(){this.elements(!0)})}}),app=new App,AppView=Backbone.View.extend({el:$("#app"),events:{"click #menu":function(){$("#sidebar").toggleClass("expanded")},"click #help":function(){this.renderMission(),app.trigger("hint")},"click #reset":function(){app.reset()},"click #missions":function(){app.menu()},"click #dashboard":function(){location.href="../dashboard"},"click #sizes":function(){app.set("physicalSizes",!app.get("physicalSizes"))},"click #zoom-in":function(){draw.setZoom(2*draw.zoom)},"click #zoom-out":function(){draw.setZoom(draw.zoom/2)},"click #zoom":function(){$("#toolbar-zoom").addClass("expanded").removeClass("hidden")},"click #zoom-close":function(){$("#toolbar-zoom").removeClass("expanded").addClass("hidden")}},initialize:function(){var e=this;e.listenTo(e.model,"change:nplanets change:time change:position change:velocity change:elements",_.throttle(e.renderInfo,500)),e.listenTo(e.model,"start change:missions reset",e.renderMission),e.listenTo(e.model,"change:state",e.setVisibility),e.listenTo(e.model,"win",e.renderWin),e.listenTo(e.model,"lose",e.renderLose),this.renderInfo(),e.listenTo(e.model,"start change:missions reset",function(){e.validateTimer&&clearTimeout(e.validateTimer)}),e.listenTo(e.model,"change:state",function(){app.get("state")==RUNNING&&(e.validateTimer&&clearTimeout(e.validateTimer),e.validateTimer=_.delay(_.bind(e.validate,e),5e3))})},missionTemplate:_.template('<div class="title"><%= title %></div><div class="subtitle"><%= subtitle %></div>'),missionDelay:7e3,topHideTimer:null,renderTopText:function(e,t){$("#text-top").html(e),$("#text-top").addClass("expanded"),$("#text-top").removeClass("in-front"),this.topHideTimer&&clearTimeout(this.topHideTimer),t&&(this.topHideTimer=_.delay(function(){$("#text-top").removeClass("expanded"),$("#text-top").removeClass("in-front")},this.missionDelay))},renderMission:function(){var e=this.model.get("currentMission"),t=this.model.get("missions").at(e);this.renderTopText(this.missionTemplate(t.attributes),!0)},els:{},renderInfo:function(){if(app.get("nplanets")>0){$("#time").text(this.model.get("time")+" days");var e=app.elements(),t=app.get("position"),s=app.get("velocity"),i=(app.get("masses"),Math.sqrt((t[X]-t[NPHYS+X])*(t[X]-t[NPHYS+X])+(t[Y]-t[NPHYS+Y])*(t[Y]-t[NPHYS+Y])+(t[Z]-t[NPHYS+Z])*(t[Z]-t[NPHYS+Z]))),n=Math.sqrt((s[X]-s[NPHYS+X])*(s[X]-s[NPHYS+X])+(s[Y]-s[NPHYS+Y])*(s[Y]-s[NPHYS+Y])+(s[Z]-s[NPHYS+Z])*(s[Z]-s[NPHYS+Z]));$("#distance").html((i*Units.RUNIT/1e11).toFixed(1)+" million km"),$("#speed").text((n*Units.RUNIT/Units.TUNIT/1e5).toFixed(1)+" km/s"),$("#eccentricity").text(e[0].eccentricity.toFixed(2))}else $("#distance").text(""),$("#speed").text(""),$("#eccentricity").text(""),$("#time").text("")},setVisibility:function(){var e=app.get("state");e==MENU?($("#sidebar").hide(),$("#help-text").removeClass("expanded"),$("#info-top").hide(),$("#help").hide(),$("#text-top").removeClass("expanded")):($("#sidebar").show(),$("#info-top").show(),$("#help").show())},canvasMouseDown:function(e){app.get("state")==PAUSED&&app.addPlanet(e.position)},validate:function(){if(app.mission().get("rule")){var e=app.mission().get("rule")();e?(this.model.win(),clearInterval(this.validateTimer)):this.model.lose()}},winTemplate:_.template('<div class="font-l"><%= win %></div><div class="font-l"><div class="color-accent"><%= stars %></div><button class="btn-jrs font-m" onClick="app.menuView.selectNextMission(); app.menu();"><span class="fa fa-graduation-cap"></span> Go to the next mission!</button></div>'),defaultEncouragement:"Good job!",winDelayMax:1e4,approxFrameRate:1/60,renderWin:function(){var e=app.mission(),t=app.get("elements"),s=0;t.length>0&&!isNaN(t[0].period)&&(s=Math.min(this.winDelayMax,t[0].period/app.get("deltat")*this.approxFrameRate*1e3)),s=Math.max(4e3,s),this.renderTopText(this.winTemplate({win:e.get("win"),stars:app.templates.starsRepr(app.stars(),app.mission().get("value"))}),!1),$("#text-top").addClass("in-front"),app.set("state",ROTATABLE)},loseTemplate:_.template('<div class="subtitle"><%= lose %></div><div><button class="btn-jrs font-m" onClick="app.reset(); app.menuView.renderMission(); "><span class="icon-thumbs-up"></span> No worries! Retry mission</button></div>'),renderLose:function(){var e=app.get("missions").at(app.get("currentMission"));$("#text-top").html(this.loseTemplate(e.attributes)),$("#text-top").addClass("expanded"),$("#text-top").addClass("in-front"),app.set("state",ROTATABLE)},auxToolbar:function(){}}),MissionHelpModel=Backbone.Model.extend({defaults:{model:app,currentHelp:0},proceed:function(){this.set("currentHelp",this.get("currentHelp")+1),this.trigger("proceed"),app.trigger("proceed")},destroy:function(){this.stopListening()},setup:function(){var e=this.get("model"),t=e.mission();if(!t.get("help"))return this.trigger("help",null),void 0;this.listenTo(e,"win",function(){this.destroy()});for(var s=t.get("help"),i=this,n=[],a=0;a<s.length;a++){var o=s[a].on;o&&("proceed"==o?this.listenTo(this,o,function(e){return function(){i.get("currentHelp")==e&&i.trigger("help",s[e])}}(a)):this.listenTo(e,o,function(e,t){return function(){n[e]||(i.trigger("help",s[e]),i.set("currentHelp",e),"hint"!=t&&(n[e]=!0))}}(a,o)),"start"==o&&this.trigger("help",t.get("help")[0]))}},initialize:function(){}}),MessageView=Backbone.View.extend({el:$("#help-body"),messagesSetup:!1,initialize:function(){this.listenToOnce(this.model,"start",function(){this.setupTemplates()}),this.listenTo(this.model,"start",function(){console.log("start, Setting up"),this.render(null),this.setupMessages()}),this.listenTo(this.model,"win lose",function(){e.render(null)});var e=this;$("#help-next").on("click",function(){e.model.proceed()})},setupTemplates:function(){if(!this.messagesSetup){for(var e=this.model.get("missions"),t=0;t<e.length;t++){var s=e.at(t),i=s.get("help");if(i){for(var n=0;n<i.length;n++)app.templates.template(i[n]);s.set("help",i)}}this.messagesSetup=!0}},setupMessages:function(){this.listener&&(this.stopListening(this.listener),this.listener.destroy(),this.listener=null),console.log(app.get("currentMission")),this.listener=new MissionHelpModel({model:this.model}),this.listenTo(this.listener,"help",this.render),this.listenTo(this.model,"help",this.render),this.listener.setup()},plainText:function(e){return e.replace(/<script.+?<\/script>/,"").replace(/<button.+?<\/button>/,"").replace(/<.+?>/g,"").replace(/&.+;/g,"")},render:function(help){var helpText=help?help.message:null,self=this;return helpText&&self.lastHelp==helpText?($("#help-text").addClass("expanded"),void 0):(self.lastHelp=helpText,_.defer(function(){app.set("interactive",!0),app.resetFlags()}),$("#help-text").removeClass("expanded"),helpText?(help.script&&eval(help.script),_.delay(function(){self.$el.html(helpText);self.plainText(helpText);if($("#help-next").on("click",function(){self.listener.proceed()}),$("#help-close").on("click",function(){self.hide()}),$("#help-next-mission").on("click",function(){self.model.nextMission()}),$("#help-text").addClass("expanded"),app.mainView.renderInfo(),help&&help.funcs)for(var e=0;e<help.funcs.length;e++)help.funcs[e]()},500),void 0):($("#help-body").html(""),void 0))},hide:function(){this.render(null)}}),AppModalView=Backbone.View.extend({el:$("#app-modal"),animate:!1,size:10,initialize:function(){this.listenTo(this.model,"loading",this.renderLoading),this.listenTo(this.model,"load",this.renderLoad),this.frame=_.bind(this.frame,this)},loadingMessage:'Traveling to the <%= world %>...<p><i class="fa fa-circle-o-notch fa-spin"></i>',frame:function(){this.size=1.02*this.size,$("#app-modal").css("background-size",this.size+"%"),this.animate&&requestAnimationFrame(this.frame)},renderLoading:function(){var e=app.get("map");this.animate=!0,this.size=10,$("#app-modal").css("background-image","url("+e[0]["travel-bg"]+")"),$("#app-modal").css("background-size","10%"),$("#app-modal").html(_.template(this.loadingMessage,e[0])),$("#app").hide(),this.$el.show(),requestAnimationFrame(this.frame)},renderLoad:function(){$("#app").show(),this.animate=!1,this.$el.hide()}});$(document).ready(function(){app.mainView=new AppView({model:app}),app.loadConfig(APP_CFG),app.templates=new Templates,app.messageView=new MessageView({model:app}),app.menuView=new AppMenuView({model:app}),app.modalView=new AppModalView({model:app}),app.settings=new AppSettings({model:app}),app.loadMissionData(),app.sounds=new SoundEngine(app),app.once("load",function(){app.sounds.playMusic("level"),null!=_.parameter("mission")&&_.defer(function(){app.setMission(_.parameter("mission"))})})});var App=Backbone.ROComputedModel.extend({}),AppView=Backbone.View.extend({}),app=new App;$(document).ready(function(){app.view=new AppView({model:app})});var DragChoice=Backbone.View.extend({QUESTION_TITLE:'<div class="question-title"><%= message %></div><ul class="uk-nestable" data-uk-nestable="{group:\'group\', maxDepth:1}"><%= listTop %></ul>',QUESTION_DRAG_TOP:"",QUESTION_ITEM:'<li><div class="uk-nestable-item"><div class="uk-nestable-handle"><%= option %></div></div></li>',QUESTION_WRAPPER:'<div class="question"><%= message %></div>',initialize:function(){var e=this,t=this.model,s=t.mission(),i=t.templates.template({message:s.get("question")});i.listTop=_.map(s.get("options"),function(t){return _.template(e.QUESTION_ITEM,{option:t})}).join(""),i.message=_.template(this.QUESTION_TITLE,i);s.get("options"),this.QUESTION_DRAG_TOP;this.help=i,this.render(),$("#info-top").hide(),this.listenTo(this.model,"answer",this.answer)},render:function(){this.model.trigger("help",this.help)},answer:function(e){e==this.model.mission().get("answer")?this.model.win():this.model.lose()}});app.components["drag-choice"]=DragChoice;var mapPlumb,AppMenuView=Backbone.View.extend({selectedMission:null,el:$("#app-menu"),events:{"click #app-menu-start":function(){this.start()}},initialize:function(){this.listenTo(this.model,"change:state",this.render);var e=this.model.get("map"),t=this.model.get("missions");this.selectedMission=this.model.mission().get("name"),this.setupMaps(e,t)},start:function(){this.model.sounds.playEffect("clickety"),this.model.setMission(this.selectedMission)},rootLevel:function(){return this.model.get("map")[this.model.mission().get("worldidx")].levels[0]},scanLevels:function(e,t,s,i){console.log(t);for(var n=0;n<t.length;n++)if(_.isString(t[n])){var a=t[n],o=app.mission(a);o.set("world",e.world),o.set("worldidx",e.worldidx),i&&(o.set("prev",i.get("name")),i.get("next")?i.get("next").push(a):i.set("next",[a])),i=o}else if(t[n].fork)for(var l=0;l<t[n].fork.length;l++)this.scanLevels(e,t[n].fork[l],s,i)},setupMaps:function(e,t){var s=this;_.each(e,function(e,i){e.levels;s.scanLevels({world:e.world,worldidx:i},e.levels,t)})},DIV_THUMB:'<div class="<%= divclass %>"><button id="app-menu-mission-box-<%= name %>" class="app-menu-mission-box <%= icon %> <%= allowed %>" title="<%= title %>"  data-uk-tooltip="{pos: \'right\', offset:10}"></button></div>',DIV_ROW:'<div class="app-menu-mission-row"><%= row %><div class="clear"></div></div>',renderTree:function(e,t,s,i){var n=this.model,a=this,o=e.get("prev"),l=!1;o?o&&n.mission(o).get("completed")&&(l=!0):l=!0;var r=(n.mission().get("name")===e.get("name"),_.template(this.DIV_THUMB,{divclass:"box"+t,name:e.get("name"),icon:e.get("icon")+"-b",allowed:l?"":"app-menu-mission-locked",title:e.get("title")}));i[s]?i[s]+=r:i[s]=r,l&&_.defer(function(){$("#app-menu-mission-box-"+e.get("name")).on("click",function(){a.select(e.get("name"))})});var p=e.get("next");p&&(1==p.length?this.renderTree(this.model.mission(p[0]),t,s+1,i):(p.length>2&&console.error("Error: limited to only two forks."),this.renderTree(this.model.mission(p[0]),t+"L",s+1,i),this.renderTree(this.model.mission(p[1]),t+"R",s+1,i)),_.defer(function(){_.each(p,function(t){mapPlumb.connect({source:"app-menu-mission-box-"+e.get("name"),target:"app-menu-mission-box-"+t,anchor:"AutoDefault"})})}))},select:function(e){console.log(e);var t=this.model,s=t.mission(e);$(".app-menu-mission-box").removeClass("app-menu-mission-box-selected"),$("#app-menu-mission-box-"+e).addClass("app-menu-mission-box-selected"),$("#app-menu-mission-title").html(s.get("title")),$("#app-menu-mission-subtitle").html(s.get("subtitle")),$("#app-menu-mission-stars").html(t.templates.starsRepr(s.get("stars"),s.get("value")));var i="";if(s.get("intro")){var n={message:s.get("intro")};t.templates.template(n),i=n.message}$("#bubble-text").html(i),this.selectedMission=e},selectNextMission:function(){var e=this.model,t=e.mission();t.get("next")&&(this.selectedMission=t.get("next")[0])},render:function(){var e=this,t=this.model,s=t.get("state"),i=t.mission().get("world"),n=_.where(t.get("map"),{world:i})[0],a=this.$el;if(mapPlumb.reset(),s===MENU){a.addClass("expanded");var o=this.rootLevel(),l=this.model.mission(o),r=[];this.renderTree(l,"",0,r);var p="";_.each(r,function(t){p+=_.template(e.DIV_ROW,{row:t})+"\n"}),console.log(n.bg),$("#app-menu-map-container").css("background-image","url("+n.bg+")"),$("#app-menu-world-name").html(n.world),$("#app-menu-map").html(p),$("#app-menu-stars-earned").html(t.starsEarnedTotal()),this.select(this.selectedMission)}else a.removeClass("expanded")}});jsPlumb.ready(function(){mapPlumb=jsPlumb.getInstance({PaintStyle:{lineWidth:6,strokeStyle:"rgb(200, 200, 200)"},Connector:["Flowchart"],Endpoint:"Blank"}),mapPlumb.setContainer("app-menu-map"),$(window).resize(function(){mapPlumb.repaintEverything()})});var AppSettings=Backbone.View.extend({el:$("#settings"),bloop:!0,soundMultiplier:250,reset:function(){var e=this;_.each(["musicVolume","effectsVolume"],function(t){$("[data-property="+t+"]").val(e.model.get(t)*e.soundMultiplier).change()})},initialize:function(){$('input[type="range"]').rangeslider({polyfill:!1});var e=this;$('input[type="range"]').on("change",function(){$(this).parent().find("output").text($(this).val());var t=$(this).data("property");e.model.set(t,(0|$(this).val())/e.soundMultiplier),e.model.sounds&&e.model.sounds.playEffect("clickety")}),this.listenTo(this.model,"change:musicVolume",function(t,s){$("[data-property=musicVolume]").val(s*e.soundMultiplier)}),this.listenTo(this.model,"change:effectsVolume",function(t,s){$("[data-property=effectsVolume]").val(s*e.soundMultiplier)}),this.reset()}}),SingleChoice=Backbone.View.extend({QUESTION_TITLE:'<div class="question-title"><%= message %></div>',QUESTION_ITEM:'<div><button class="question-option btn btn-lg btn-jrs " onClick="app.trigger(\'answer\', <%= index %>);"><%= message %></button></div>',QUESTION_BOTTOM:'<div class="question-title"><%= message %></div>',QUESTION_WRAPPER:'<div class="question"><%= message %></div>',initialize:function(){var e=this.model,t=e.mission(),s=e.templates.template({message:t.get("question")});s.message=_.template(this.QUESTION_TITLE,s);for(var i=t.get("choices"),n=0;n<i.length;n++)s.message+=_.template(this.QUESTION_ITEM,{message:i[n],index:n});s.message+=_.template(this.QUESTION_BOTTOM,{message:t.get("question-below")}),s.message=_.template(this.QUESTION_WRAPPER,s),this.help=s,this.render(),$("#info-top").hide(),this.listenTo(this.model,"answer",this.answer)},render:function(){this.model.trigger("help",this.help)},answer:function(e){e==this.model.mission().get("answer")?this.model.win():this.model.lose()}});app.components["single-choice"]=SingleChoice;var SoundEngine=Backbone.ROComputedModel.extend({initialize:function(e){var t=this;this.model=e;var s=e;this.assets=s.get("assets"),_.map(this.assets.effects,function(e,i){t[i]=t.newAudio(e),t.listenTo(s,i,function(){t.playEffect(i)})}),this.musicPlayer=new Audio,this.musicPlayer.loop=!0,this.musicPlayer.volume=s.get("musicVolume"),this.listenTo(s,"change:musicVolume",function(){this.musicPlayer.volume=s.get("musicVolume")}),window.onfocus=function(){t.musicPlayer.volume=s.get("musicVolume")},window.onblur=function(){t.musicPlayer.volume=0}},newAudio:function(e){var t=new Audio;return t.src=e,t.volume=this.model.get("effectsVolume"),t},playEffect:function(e){if(0!=this.model.get("effectsVolume"))try{this.assets.effects[e]?(this[e].currentTime=0,0!=this[e].currentTime&&this[e].load(),this[e].volume=app.get("effectsVolume"),this[e].play()):console.warn("No sound effect of type ",e)}catch(t){console.log(t)}},playMusic:function(e){0!=this.model.get("musicVolume")&&(this.musicPlayer.src=this.assets.music[e],this.musicPlayer.play())}}),Templates=Backbone.Model.extend({safeTags:["h1","h2","h3","h4","h5","h6"],NEXT_LABEL:'<span class="fa fa-chevron-circle-right"></span> Next',NEXT_MISSION_LABEL:'<span class="fa fa-thumbs-up"></span> Next Mission',FULL_STAR:'<span class="icon-win-star"></span> ',EMPTY_STAR:'<span class="icon-win-star-o"></span> ',templates:{"@separator":'<div class="separator"></div>',"@icon-([\\w\\-]+)":'<span class="icon-$1"></span>',"@color-([\\w\\-]+)\\{(.+?)\\}":'<span class="color-$1">$2</span>',"@noninteractive":function(){app.set("interactive",!1)},"@disable-star":function(){app.flags.disabledStar=!0},"@disable-planet-drag":function(){app.flags.disabledPlanetDrag=!0},"@disable-velocity-drag":function(){app.flags.disabledVelocityDrag=!0},"@disable-velocity":function(){app.flags.disabledVelocity=!0},"@disable-force":function(){app.flags.disabledForce=!0},"@refresh":function(){app.trigger("refresh")},"@enter-avatar":function(){_.delay(function(){$(".avatar-left").addClass("avatar-left-visible"),$(".avatar-right").addClass("avatar-right-visible")},100)},"@stop-fly":function(){draw.cancelFly(),console.log("Cancel Fly!")},"@fly":function(){draw.fly(),console.log("Fly!")},"@hide-10":function(){_.delay(function(e){e.hide()},1e4,this)},"@hide-5":function(){_.delay(function(e){e.hide()},5e3,this)},"@hide":function(){this.hide()},"\\*(.+?)\\*":"<strong>$1</strong>","\\{(.+?)\\}":"<img src=$1>","\\[(.+?)\\]\\((.+?)\\)":'<a href="$2" target="_blank">$1</a>',"^(#)\\s*(.+)":"<h1>$2</h1>","^s*$":"<br>","@proceed-win":'<div class="help-toolbar"><button id="help-next-mission" class="btn btn-lg btn-jrs"><span class="fa fa-thumbs-up"></span>  Next mission</button></div>',"@proceed-hidden":'<div class="help-toolbar"><button id="help-next" style="display:none" class="btn btn-lg btn-jrs"><span class="fa fa-chevron-right"></span>  Next</button></div>',"@proceed":'<div class="help-toolbar"><button id="help-next" class="btn btn-lg btn-jrs"><span class="fa fa-chevron-right"></span>  Next</button></div>',"@close":'<div class="help-toolbar"><button id="help-close" class="btn btn-lg btn-jrs"><span class="fa fa-times"></span>  Close</button></div>',"@eccentricity":'<span id="eccentricity"></span>',"@name":LOGGED_USER,"@run":function(){app.set("state",RUNNING)},"@rotatable":function(){app.set("state",ROTATABLE)},"@wait-10":function(){_.delay(function(e){e.listener.proceed()},1e4,this)},"@wait-5":function(){_.delay(function(e){e.listener.proceed()},5e3,this)}},firstRun:!0,template:function(e,t){this.firstRun&&(this.templates=_.extend(this.templates,app.get("avatars")),this.firstRun=!1);var s=e.message,i=this.templates;t=t||this,e.old_message=s,s=_.str.escapeHTML(s),e.funcs=[];for(;;){var n=_.reduce(_.keys(i),function(s,n){var a=i[n];return _.isFunction(i[n])&&-1!=s.indexOf(n)&&(e.funcs.push(_.bind(i[n],t)),a=""),s.replace(new RegExp(n,"gm"),a)},s);if(s==n)break;s=n}return e.message=s,e},starsRepr:function(e,t){var s="";t=t||3;for(var i=0;e>i;i++)s+=this.FULL_STAR;for(i=e;t>i;i++)s+=this.EMPTY_STAR;return s},initialize:function(){for(var e=this.safeTags,t=0;t<e.length;t++)this.templates["@"+e[t]]="<"+e[t]+">",this.templates["@/"+e[t]]="</"+e[t]+">"}}),UI={};
//# sourceMappingURL=app_source_map