var M=0,X=1,Y=2,Z=3,U=4,V=5,W=6,NCOORDS=7,NPHYS=4,AU=14959787e6,MSUN=1.98892e33,MJUP=1.8986e30,MEARTH=5.97219e27,RJUP=71e8,RSUN=696e8,REARTH=63e7,GGRAV=6.67384e-8,MIN_DISTANCE=300*RJUP/AU,DAY=86400,TWOPI=6.2831853072,SQRT_TWOPI=2.5066282746,K2=GGRAV*MSUN*DAY*DAY/(AU*AU*AU),YEAR=31556926;NBODIES=12,nbodies=1;var System=function(){var e=[],t=[],o=[],n=null,r=new Float64Array(NCOORDS),s=function(i){var r;for(e.length=0,t.length=0,o.length=0,h=0,r=0;NBODIES>r;r++)e.push(new Float64Array(NCOORDS)),t.push(new Float64Array(NPHYS)),o.push(new Float64Array(NPHYS));nbodies=1,e[0][M]=1*K2,l(),n=i},a=function(t,o,i,n,r){if(!(nbodies>=NBODIES)){e[nbodies][X]=o,e[nbodies][Y]=i,o-=e[0][X],i-=e[0][Y];var s=Math.sqrt(o*o+i*i);e[nbodies][M]=t*K2;var a=Math.sqrt((e[0][M]+e[nbodies][M])/s);void 0===n?(e[nbodies][U]=a*(-i/s),e[nbodies][V]=a*(o/s)):(e[nbodies][U]=n,e[nbodies][V]=r),nbodies++,l()}},c=function(){var t,o;for(t=0;NCOORDS>t;t++)r[t]=0;for(t=0;nbodies>t;t++)for(r[M]+=e[t][M],o=0;NCOORDS>o;o++)r[o]+=e[t][o]*e[t][M];for(r[X]/=r[M],r[Y]/=r[M],r[Z]/=r[M],r[U]/=r[M],r[V]/=r[M],r[W]/=r[M],t=0;nbodies>t;t++)for(o=X;W>=o;o++)e[t][o]-=r[o]},l=function(){var i,n;for(i=0;nbodies>i;i++)for(o[i].set(t[i]),n=0;NPHYS>n;n++)t[i][n]=0;for(i=0;nbodies>i;i++)for(n=i+1;nbodies>n;n++){var r=e[i][M],s=e[n][M],a=e[i][X]-e[n][X],c=e[i][Y]-e[n][Y],l=e[i][Z]-e[n][Z],h=1/(a*a+c*c+l*l),p=Math.sqrt(h);if(MIN_DISTANCE>p)return UI.crash(i,n),void 0;var d=-s*h*p,u=-r*h*p;t[i][X]+=a*d,t[n][X]-=a*u,t[i][Y]+=c*d,t[n][Y]-=c*u,t[i][Z]+=l*d,t[n][Z]-=l*u}},h=0,p=.5,d=p*p,u=function(e){p=e,d=p*p},f=function(t){e[0][M]=t*K2},m=function(n){n=1|n;for(var r=0;n>r;r++){var s;for(i=0;nbodies>i;i++)for(s=X;Z>=s;s++)e[i][s]+=e[i][s+3]*p+.5*d*t[i][s];for(l(),i=0;nbodies>i;i++)for(s=X;Z>=s;s++)e[i][s+3]+=.5*p*(t[i][s]+o[i][s]);h+=p}return e},E=function(){for(var t=0;nbodies>t;t++)console.log(e[t][0]-e[0][0],e[t][1]-e[0][1],e[t][2]-e[0][2],e[t][3]-e[0][3],e[t][4]-e[0][4],e[t][5]-e[0][5],e[t][6]-e[0][6]),console.log(Math.sqrt(sqr(e[t][X]-e[0][X])+sqr(e[t][Y]-e[0][Y])));console.log(nbodies,h),console.log("-----------------")},S=function(){a(.001,1.5,0),a(.001,1.5,0),a(.001,1.5,0),a(.001,1.5,0),a(.001,1.5,0),c(),console.time("Start"),m(1e5),console.timeEnd("Start"),alert()},y=function(){return h},b=function(e){h=e},v=function(){for(var t=[],o=0;nbodies>o;o++)t[o]=e[o][M];return t};return{init:s,xyz:e,evolve:m,addPlanet:a,benchmark:S,print:E,time:y,setTime:b,center:c,masses:v,setDt:u,setMstar:f}}();Math.log10=function(e){return Math.log(e)/Math.LN10},TAIL_LENGTH=200,SPEED=8,STOPPED=!1,CLICKED=!1,CRASHED_BARRIER=!1,VIEW_ONLY=null!=_.parameter("view"),IS_MOBILE=null!=_.parameter("mobile"),IS_TEMPLATE=null!=_.parameter("np"),RESET_VIEW=!1,HABITABLE_ZONE_MIN_2=.522729,HABITABLE_ZONE_MAX_2=2.322576,IN_HABITABLE=0,ADD_CIRCLE_AT=-1,MAX_SPEED=128;var UI=function(){function e(){if(VIEW_ONLY||IS_TEMPLATE){if(VIEW_ONLY)MIRRORED=1,$("#cfg").html("You are watching the pre-recorded evolution of this system. Sit back and relax...<hr>"),$.get("hiscore.php",{view:_.parameter("view"),token:w},function(e){console.log(e),D=JSON.parse(e),$("#popup").hide(),$("#pop-help").hide()});else if(_.parameter("np")){b=.1;for(var e=1;e<=_.parameter("np")|0;e++){var t=+_.parameter("x"+e),o=+_.parameter("y"+e),i=+_.parameter("vx"+e),n=+_.parameter("vy"+e),a=+_.parameter("m"+e);b=Math.max(b,1.25*Math.sqrt(t*t+o*o)),r(t,o,i,n,a,!0)}System.center(),SPEED=+_.parameter("speed"),_.parameter("dt")&&System.setDt(+_.parameter("dt")),A=.98*b,v=.05*b}}else E();SCALE=IS_MOBILE?.45*Math.min(window.innerHeight,window.innerWidth)/b:.45*Math.min(window.innerHeight,window.innerWidth-520)/b,$.get("hiscore_today.php?get=get",null,function(e){$("#highscores-list").html("Today's high score: <strong>"+e+"</strong>")}),$(".mass-sel").click(function(){P=0|$(this).data("points"),P*=MEARTH/MSUN,x=$(this).text(),$("#masses li.active").removeClass("active"),$(this).parent("li").addClass("active")}),$("#pause").click(function(){STOPPED=!STOPPED,STOPPED?$("#pause").html('<span class="glyphicon glyphicon-play"></span>'):$("#pause").html('<span class="glyphicon glyphicon-pause"></span>')}),$("#stop").off("click").click(h),$("#help").click(function(){$("#popup").show(500),$("#pop-help").show(),$("#pop-why").hide(),$("#pop-points").hide()}),$("#pop-highscores").hide(),$("#pop-points").hide(),$("#screenshot").click(function(){var e=document.getElementById("universe"),t=e.getContext("2d");t.fillStyle="white",t.font="16px Exo",t.fillText("Super Planet Crash - Brought to you by Stefano Meschiari - http://www.stefanom.org/spc",20,30);var o=e.toDataURL("image/png");window.open(o,"_blank")}),$("#hiscore-form").submit(function(e){if(e.preventDefault(),$("#hiscore-submit").css("disabled","true"),$("#hiscore-submit").html("Submitting..."),$("#hiscore-points").val(s()),$("#hiscore-years").val(l()),""==$("#hiscore-name").val().trim())return alert("Insert a name."),void 0;var t={};t["hiscore-points"]=s(),t["hiscore-years"]=l(),t["hiscore-name"]=$("#hiscore-name").val(),t.history=JSON.stringify(g),$.post("hiscore.php?token="+w,$(this).serialize(),function(e){alert("High score saved!\nYou are in position #"+((0|e)+1)),location.href=BASEURL})}),$("#hiscore-url-full").click(function(){$(this).select()}),$("#faster").click(function(){SPEED*=2,SPEED>MAX_SPEED&&(SPEED=MAX_SPEED)}),$("#slower").click(function(){SPEED=Math.round(.5*SPEED),1>SPEED&&(SPEED=1)}),$("#templates").click(function(){location.href="templates.html"}),$("#newgame").click(function(){UI.restart()}),$("a.spc").attr("href",BASEURL),$("#maxAU").html(f().toFixed(2))}function t(){if(VIEW_ONLY&&null==D)return null;for(var e,t=0;SPEED>t;t++){if(o(1),VIEW_ONLY)for(var i=D.length-1;i>=0;)D[i].mstar?System.xyz[0][M]=D[i].mstar*K2:D[i].time==System.time()&&(P=+D[i].mass,r(+D[i].x,+D[i].y,+D[i].u,+D[i].v,!1,!1,!D[i].corr),D.splice(i,1)),i--;e=System.evolve()}return T(),e}function o(e){if(!(3>nbodies)){var t=0,o=System.xyz,n=[];for(R=1,IN_HABITABLE=0,i=1;nbodies>i;i++){t+=o[i][M]/K2*MSUN/MEARTH;var r=o[i][X]*o[i][X]+o[i][Y]*o[i][Y];n[i-1]=r,r>HABITABLE_ZONE_MIN_2&&HABITABLE_ZONE_MAX_2>r&&(R++,IN_HABITABLE++)}nbodies>2&&(N=Math.max(Math.min(1/_.sd(n),10),1)),t*=e/1826.25*N*R,y+=t}}function n(){if(nbodies!=O){$("#nplanets").text(nbodies+" / "+NBODIES+" bodies");var e=System.xyz;$("#planets-list").html("");for(var t=1;nbodies>t;t++){var o=" ["+(e[t][M]/K2*MSUN/MEARTH).toFixed(0)+" M<sub>earth</sub>] ",i=$('<div class="planet" id="pla'+t+'"><span style="color:'+COLORS[t]+'"> Planet '+t+o+"</span></div>");$("#planets-list").append(i)}O=nbodies}}function r(e,t,o,i,r,s,a){if(nbodies!=NBODIES){var c=Math.sqrt(e*e+t*t);if(v>c&&!s)e*=v/c,t*=v/c;else if(c>A)return;if(r||(r=P),a){var l=[],h=r*K2,p=0,d=System.xyz;l[X]=l[Y]=l[Z]=l[U]=l[V]=l[W]=0;for(var u=0;nbodies>u;u++){p+=d[u][M];for(var f=X;W>=f;f++)l[f]+=d[u][f]*d[u][M]}e=(e+l[X]/(p+h))/(1-h/(p+h)),t=(t+l[Y]/(p+h))/(1-h/(p+h)),o=(o+l[U]/(p+h))/(1-h/(p+h)),i=(i+l[V]/(p+h))/(1-h/(p+h)),console.log("Correcting for history bug.")}else console.log("No correction.");System.addPlanet(r,e,t,o,i),xyz=System.xyz,g.push({time:System.time(),mass:P.toFixed(20),x:xyz[nbodies-1][X].toFixed(20),y:xyz[nbodies-1][Y].toFixed(20),z:xyz[nbodies-1][Z].toFixed(20),u:xyz[nbodies-1][U].toFixed(20),v:xyz[nbodies-1][V].toFixed(20),w:xyz[nbodies-1][W].toFixed(20),corr:!0}),s||System.center(),n(),3==nbodies&&(CLICKED=!0,y=0,System.setTime(0))}}function s(){return Math.round(y)}function a(){var e=s();return e}function c(e){e/=K2;var t,o=e*MSUN/MJUP;return o>.29&&13>o?t=1:.29>o?t=Math.sqrt(o*MJUP/MEARTH)*REARTH/RJUP:o>13&&(t=Math.sqrt(e)*RSUN/RJUP),t=Math.floor(20*Math.pow(t,.25))}function l(){return CLICKED?(System.time()/365.25).toFixed(1):0}function h(){if(STOPPED=!0,$("#pause").attr("disabled",!0),$("#stop").text("New game"),$("#stop").click(function(){UI.restart()}),!VIEW_ONLY){$("#pop-help").hide(),$("#pop-points").show(),$("#pop-points-tot").text(_.numberWithCommas(a())),$("#pop-years-tot").text(l()),$("#popup").show(500);var e=!1;$.get("hiscore_today.php?points="+a()+"&years="+l()+"&nbody="+nbodies,null,function(t){var o=0|+t;o==(0|a())&&o>0&&($("#pop-hiscore").html('<hr><i class="glyphicon glyphicon-certificate"></i> You are today\'s top scorer!'),e=!0),_.delay(function(){STOPPED&&m()},1e3*(e?30:15))})}}function p(e,t){$("#pop-why").show(),$("#pop-why").html("Bodies "+e+" and "+t+" crashed!<hr>"),h()}function d(){for(var e=System.xyz,t=0;nbodies>t;t++)e[t][X]*e[t][X]+e[t][Y]*e[t][Y]>b*b&&(STOPPED=!0,$("#pop-why").show(),$("#pop-why").html("Body #"+t+" crashed against the barrier at "+b.toFixed(2)+" AU!<hr>"));STOPPED&&(CRASHED_BARRIER=!0,h()),l()>I&&($("#pop-why").show(),$("#pop-why").html("Congrats! You reached "+I+" years without going unstable!<hr>"),h())}function u(){return x}function f(){return b}function m(){location.reload(!0),location.href=BASEURL}function E(){var e=v+Math.random()*(A-v);P=MEARTH/MSUN,x="1x\nEarth",r(e,0)}function S(e){w=e}var y=0,b=2,v=.15*b,A=.98*b,I=500,P=MEARTH/MSUN,x="1x\nEarth",g=[],D=null,N=1,R=1,w=0,T=_.throttle(function(){$("#time").html("Years:<br>"+UI.years()+"/500"),$("#points").html("Points:<br>"+_.numberWithCommas(UI.points())),$("#bonus").html("Crowdedness bonus: "+N.toFixed(1)+"x<br>Habitability bonus: "+R.toFixed(1)+"x<br>Speed: "+SPEED+"x")},1e3),O=-1;return{init:e,evolve:t,mtor:c,years:l,points:s,addPlanetAt:r,stop:h,crash:p,check:d,planetType:u,maxSemiMajorAxis:f,restart:m,addFirstPlanet:E,setToken:S}}();$(document).ready(function(){System.init(UI),UI.init(),_.parameter("benchmark")&&System.benchmark()});